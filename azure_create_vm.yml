- name: Create Azure VM
  hosts: localhost
  connection: local
  vars:
    resource_group: demo
    location: northeurope
    vm_name: demo-vm

  tasks:
  - name: Create the resource group
    azure_rm_resourcegroup:
      name: "{{ resource_group }}"
      location: "{{ location }}"

  - name: Create virtual network
    azure_rm_virtualnetwork:
      resource_group: "{{ resource_group }}"
      name: "{{ resource_group }}-vnet"
      address_prefixes: "10.0.0.0/16"

  - name: Add subnet
    azure_rm_subnet:
      resource_group: "{{ resource_group }}"
      name: "{{ resource_group }}-snet"
      address_prefix: "10.0.1.0/24"
      virtual_network: "{{ resource_group }}-vnet"

  - name: Create public IP address
    azure_rm_publicipaddress:
      resource_group: "{{ resource_group }}"
      allocation_method: Static
      name: "{{ vm_name }}-ip"
    register: publicip

  - name: Show Public IP address
    debug:
      msg: "{{ publicip }}"

  - name: Create Network Security Group that allows SSH/Cockpit
    azure_rm_securitygroup:
      resource_group: "{{ resource_group }}"
      name: "{{ resource_group }}-nsg"
      rules:
        - name: SSH
          protocol: Tcp
          destination_port_range: 22
          access: Allow
          priority: 101
          direction: Inbound
        - name: COCKPIT
          protocol: Tcp
          destination_port_range: 9090
          access: Allow
          priority: 102
          direction: Inbound

  - name: Create virtual network inteface card
    azure_rm_networkinterface:
      resource_group: "{{ resource_group }}"
      name: "{{ vm_name }}-Nic"
      virtual_network: "{{ resource_group }}-vnet"
      subnet: "{{ resource_group }}-snet"
      public_ip_name: "{{ vm_name }}-ip"
      security_group: "{{ resource_group }}-nsg"
